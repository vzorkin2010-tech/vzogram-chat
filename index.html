<script type="module">
    // üî• FIREBASE CONFIG
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        doc, 
        addDoc, 
        updateDoc, 
        onSnapshot, 
        query, 
        where, 
        orderBy, 
        serverTimestamp,
        getDocs
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut,
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBAUSG6UihJ4R7aIbAvqJk-usg68nW4LIE",
        authDomain: "vzogram-chat.firebaseapp.com",
        projectId: "vzogram-chat",
        storageBucket: "vzogram-chat.firebasestorage.app",
        messagingSenderId: "81186092337",
        appId: "1:81186092337:web:949f084dee00e72b89ac10"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUser = null;
    let currentChat = null;
    let users = [];
    let chats = [];
    let isMobile = window.innerWidth < 768;
    let messagesUnsubscribe = null;
    let chatsUnsubscribe = null;
    let usersUnsubscribe = null;

    // üî• –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
    window.showRegister = function() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
    }

    window.showLogin = function() {
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
    }

    window.register = async function() {
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value.trim();

        if (!name || !email || !password) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        try {
            setButtonLoading('registerButton', true);
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore
            await addDoc(collection(db, "users"), {
                uid: user.uid,
                name: name,
                email: email,
                status: 'online',
                lastSeen: serverTimestamp(),
                createdAt: serverTimestamp()
            });

            showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            showLogin(); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
        } finally {
            setButtonLoading('registerButton', false);
        }
    }

    window.login = async function() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!email || !password) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        try {
            setButtonLoading('loginButton', true);
            
            await signInWithEmailAndPassword(auth, email, password);
            showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
        } finally {
            setButtonLoading('loginButton', false);
        }
    }

    function setButtonLoading(buttonId, loading) {
        const button = document.getElementById(buttonId);
        const buttonText = document.getElementById(buttonId + 'Text');
        
        if (loading) {
            button.disabled = true;
            buttonText.innerHTML = '<div class="loading"></div>';
        } else {
            button.disabled = false;
            buttonText.textContent = buttonId === 'loginButton' ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
        }
    }

    // üî• –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
    function showMainApp() {
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        
        updateUI();
        setupRealTimeListeners();
        setupSearch();
    }

    function setupRealTimeListeners() {
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
        usersUnsubscribe = onSnapshot(collection(db, "users"), (snapshot) => {
            users = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(user => user.uid !== currentUser.uid);
        });

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const chatsQuery = query(
            collection(db, "chats"),
            where("participants", "array-contains", currentUser.uid)
        );
        
        chatsUnsubscribe = onSnapshot(chatsQuery, (snapshot) => {
            chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateChatList();
        });
    }

    function updateUI() {
        if (!currentUser) return;

        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
        document.getElementById('userStatus').textContent = currentUser.status;
        
        document.getElementById('profileName').value = currentUser.name;
        document.getElementById('profileStatus').value = currentUser.status || '';
    }

    // üî• –†–ê–ë–û–¢–ê –° –ß–ê–¢–ê–ú–ò
    function updateChatList() {
        const chatsList = document.getElementById('chatsList');
        chatsList.innerHTML = '';

        if (chats.length === 0) {
            chatsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
                </div>
            `;
            return;
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–∞—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        const sortedChats = [...chats].sort((a, b) => {
            const timeA = a.lastMessageTime?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
            const timeB = b.lastMessageTime?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
            return timeB - timeA;
        });

        sortedChats.forEach(chat => {
            const chatItem = createChatItem(chat);
            chatsList.appendChild(chatItem);
        });
    }

    function createChatItem(chat) {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        if (currentChat && currentChat.id === chat.id) {
            chatItem.classList.add('active');
        }
        chatItem.dataset.chatId = chat.id;
        
        const chatName = getChatName(chat);
        const lastMessage = chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
        const time = formatTime(chat.lastMessageTime);

        chatItem.innerHTML = `
            <div class="chat-avatar">${chatName.charAt(0)}</div>
            <div class="chat-info">
                <div class="chat-name">${chatName}</div>
                <div class="chat-last-message">${lastMessage}</div>
            </div>
            <div class="chat-time">${time}</div>
        `;

        chatItem.addEventListener('click', () => selectChat(chat));
        return chatItem;
    }

    function getChatName(chat) {
        if (chat.name) return chat.name;
        if (chat.participants && chat.participants.length === 2) {
            const otherUserId = chat.participants.find(id => id !== currentUser.uid);
            const otherUser = users.find(u => u.uid === otherUserId);
            return otherUser ? otherUser.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        return '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç';
    }

    // üî• –í–´–ë–û–† –ß–ê–¢–ê –ò –°–û–û–ë–©–ï–ù–ò–Ø
    async function selectChat(chat) {
        if (messagesUnsubscribe) {
            messagesUnsubscribe();
        }

        currentChat = chat;
        
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        const activeChat = document.querySelector(`[data-chat-id="${chat.id}"]`);
        if (activeChat) {
            activeChat.classList.add('active');
        }
        
        updateChatHeader();
        
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = `–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ${getChatName(chat)}...`;
        messageInput.disabled = false;
        messageInput.focus();

        loadMessages(chat.id);
        
        if (isMobile) {
            toggleSidebar();
        }
    }

    function updateChatHeader() {
        if (!currentChat) return;
        
        const chatName = getChatName(currentChat);
        document.getElementById('currentChatName').textContent = chatName;
        document.getElementById('currentChatAvatar').textContent = chatName.charAt(0);
        
        if (currentChat.participants && currentChat.participants.length === 2) {
            const otherUserId = currentChat.participants.find(id => id !== currentUser.uid);
            const otherUser = users.find(u => u.uid === otherUserId);
            if (otherUser) {
                document.getElementById('currentChatStatus').textContent = otherUser.status || '–æ–Ω–ª–∞–π–Ω';
                const lastSeen = otherUser.lastSeen?.toDate?.();
                document.getElementById('currentChatLastSeen').textContent = 
                    otherUser.status === 'online' ? '–≤ —Å–µ—Ç–∏' : formatLastSeen(lastSeen);
            }
        } else {
            document.getElementById('currentChatStatus').textContent = '–≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç';
            document.getElementById('currentChatLastSeen').textContent = '';
        }
    }

    function loadMessages(chatId) {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comment"></i>
                <h3>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</h3>
            </div>
        `;

        const messagesQuery = query(
            collection(db, "messages"),
            where("chatId", "==", chatId),
            orderBy("timestamp", "asc")
        );

        messagesUnsubscribe = onSnapshot(messagesQuery, (snapshot) => {
            const messages = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate()
            }));

            displayMessages(messages);
        });
    }

    function displayMessages(messages) {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';

        if (messages.length === 0) {
            messagesContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comment"></i>
                    <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                </div>
            `;
            return;
        }

        messages.forEach(message => {
            displayMessage(message);
        });

        scrollToBottom();
    }

    function displayMessage(message) {
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = messagesContainer.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        const messageDiv = document.createElement('div');
        const isSent = message.senderId === currentUser.uid;

        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        
        const time = message.timestamp ? 
            message.timestamp.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) : '—Ç–æ–ª—å–∫–æ —á—Ç–æ';

        messageDiv.innerHTML = `
            <div class="message-text">${escapeHtml(message.text)}</div>
            <div class="message-time">${time}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    }

    // üî• –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
    window.sendMessage = async function() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text || !currentChat) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
            return;
        }

        try {
            const messageData = {
                text: text,
                senderId: currentUser.uid,
                senderName: currentUser.name,
                timestamp: serverTimestamp(),
                chatId: currentChat.id
            };

            await addDoc(collection(db, "messages"), messageData);

            await updateDoc(doc(db, "chats", currentChat.id), {
                lastMessage: text.length > 30 ? text.substring(0, 30) + '...' : text,
                lastMessageTime: serverTimestamp()
            });

            input.value = '';
            autoResizeTextarea();
            scrollToBottom();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    }

    // üî• –°–û–ó–î–ê–ù–ò–ï –ß–ê–¢–û–í
    window.showNewChatModal = function() {
        document.getElementById('newChatModal').classList.remove('hidden');
        updateUserList();
    }

    function updateUserList() {
        const userList = document.getElementById('userList');
        userList.innerHTML = '';

        if (users.length === 0) {
            userList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <h3>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <p>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                </div>
            `;
            return;
        }

        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-list-item';
            userItem.innerHTML = `
                <div class="user-avatar" style="width: 40px; height: 40px; font-size: 16px;">
                    ${user.name.charAt(0)}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold;">${user.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${user.email}</div>
                </div>
                <div class="checkbox"></div>
            `;
            userItem.addEventListener('click', () => {
                userItem.classList.toggle('selected');
            });
            userList.appendChild(userItem);
        });
    }

    window.createChat = async function() {
        const chatName = document.getElementById('chatNameInput').value.trim();
        const selectedUsers = Array.from(document.querySelectorAll('.user-list-item.selected'))
            .map(item => {
                const userName = item.querySelector('div div').textContent;
                return users.find(user => user.name === userName);
            })
            .filter(user => user);

        if (selectedUsers.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            return;
        }

        const participants = [currentUser.uid, ...selectedUsers.map(user => user.uid)];
        const isGroup = participants.length > 2;

        try {
            const chatData = {
                participants: participants,
                createdAt: serverTimestamp(),
                lastMessage: '–ß–∞—Ç —Å–æ–∑–¥–∞–Ω',
                lastMessageTime: serverTimestamp(),
                creator: currentUser.uid
            };

            if (isGroup && chatName) {
                chatData.name = chatName;
            } else if (isGroup) {
                chatData.name = `–ß–∞—Ç ${selectedUsers.map(u => u.name).join(', ')}`;
            }

            await addDoc(collection(db, "chats"), chatData);
            
            showNotification('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
            closeModal('newChatModal');
            document.getElementById('chatNameInput').value = '';
            document.querySelectorAll('.user-list-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞');
        }
    }

    // üî• –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    function formatTime(timestamp) {
        if (!timestamp) return '';
        try {
            const date = timestamp.toDate();
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω`;
            if (diff < 86400000) return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('ru-RU');
        } catch (e) {
            return '';
        }
    }

    function formatLastSeen(timestamp) {
        if (!timestamp) return '';
        try {
            const date = timestamp;
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600000) return `–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏ ${Math.floor(diff / 60000)} –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥`;
            if (diff < 86400000) return `–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏ —Å–µ–≥–æ–¥–Ω—è –≤ ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
            return `–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏ ${date.toLocaleDateString('ru-RU')}`;
        } catch (e) {
            return '';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }

    window.closeModal = function(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    window.showProfileSettings = function() {
        document.getElementById('profileModal').classList.remove('hidden');
    }

    window.updateProfile = async function() {
        const name = document.getElementById('profileName').value.trim();
        const status = document.getElementById('profileStatus').value.trim();

        if (!name) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            return;
        }

        try {
            // –ù–∞—Ö–æ–¥–∏–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ uid
            const usersSnapshot = await getDocs(query(collection(db, "users"), where("uid", "==", currentUser.uid)));
            if (!usersSnapshot.empty) {
                const userDoc = usersSnapshot.docs[0];
                await updateDoc(doc(db, "users", userDoc.id), {
                    name: name,
                    status: status
                });

                currentUser.name = name;
                currentUser.status = status;
                
                updateUI();
                showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                closeModal('profileModal');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
        }
    }

    window.showChatOptions = function() {
        if (currentChat) {
            showNotification(`–û–ø—Ü–∏–∏ —á–∞—Ç–∞ "${getChatName(currentChat)}"`);
        } else {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
        }
    }

    window.logout = async function() {
        try {
            if (currentUser) {
                const usersSnapshot = await getDocs(query(collection(db, "users"), where("uid", "==", currentUser.uid)));
                if (!usersSnapshot.empty) {
                    const userDoc = usersSnapshot.docs[0];
                    await updateDoc(doc(db, "users", userDoc.id), {
                        status: 'offline',
                        lastSeen: serverTimestamp()
                    });
                }
            }

            if (messagesUnsubscribe) messagesUnsubscribe();
            if (chatsUnsubscribe) chatsUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();

            await signOut(auth);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
        }
    }

    function showNotification(text) {
        const notification = document.getElementById('notification');
        notification.querySelector('#notificationText').textContent = text;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function autoResizeTextarea() {
        const textarea = document.getElementById('messageInput');
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function scrollToBottom() {
        const messagesContainer = document.getElementById('messagesContainer');
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm.length === 0) {
                    updateChatList();
                    return;
                }

                const filteredChats = chats.filter(chat => {
                    const chatName = getChatName(chat);
                    return chatName.toLowerCase().includes(searchTerm) ||
                           (chat.lastMessage && chat.lastMessage.toLowerCase().includes(searchTerm));
                });

                displaySearchResults(filteredChats);
            }, 300);
        });
    }

    function displaySearchResults(chats) {
        const chatsList = document.getElementById('chatsList');
        chatsList.innerHTML = '';

        if (chats.length === 0) {
            chatsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                </div>
            `;
            return;
        }

        chats.forEach(chat => {
            const chatItem = createChatItem(chat);
            chatsList.appendChild(chatItem);
        });
    }

    // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
    onAuthStateChanged(auth, async (user) => {
        console.log('Auth state changed:', user);
        if (user) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore
                const usersSnapshot = await getDocs(query(collection(db, "users"), where("uid", "==", user.uid)));
                if (!usersSnapshot.empty) {
                    const userDoc = usersSnapshot.docs[0];
                    const userData = userDoc.data();
                    currentUser = { 
                        uid: user.uid, 
                        name: userData.name, 
                        email: userData.email,
                        status: userData.status || 'online'
                    };
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ–Ω–ª–∞–π–Ω
                    await updateDoc(doc(db, "users", userDoc.id), {
                        status: 'online',
                        lastSeen: serverTimestamp()
                    });
                    
                    console.log('User loaded, showing main app');
                    showMainApp();
                } else {
                    console.error('User document not found in Firestore');
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
            console.log('User signed out');
            if (currentUser) {
                currentUser = null;
                currentChat = null;
                users = [];
                chats = [];
                
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('authContainer').classList.remove('hidden');
            }
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('load', function() {
        console.log('App loaded');
        isMobile = window.innerWidth < 768;
        
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('input', autoResizeTextarea);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.add('hidden');
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('Current auth state:', auth.currentUser);
    });

    window.addEventListener('resize', function() {
        isMobile = window.innerWidth < 768;
    });
</script>
